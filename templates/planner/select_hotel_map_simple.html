{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% block title %}Select Hotel - GoMyanmar{% endblock %}

{% block extra_css %}
<style>
    #hotelMap {
        height: 500px;
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .map-container {
        position: relative;
        margin-bottom: 2rem;
    }
    
    .price-badge {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .real-hotel-badge {
        background: linear-gradient(135deg, #EF4444, #DC2626);
        color: white;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .hotel-item {
        cursor: pointer;
        transition: all 0.3s;
        border-left: 3px solid transparent;
    }
    
    .hotel-item:hover {
        background-color: #f8fafc;
        border-left-color: #3b82f6;
    }
    
    .hotel-item.selected {
        background-color: #e0f2fe;
        border-left: 3px solid #3b82f6;
    }
    
    /* Custom marker styles */
    .custom-marker {
        background-color: #3b82f6;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        text-align: center;
        line-height: 25px;
        color: white;
        font-weight: bold;
    }
    
    .custom-marker.real {
        background-color: #ef4444;
    }
    
    .custom-marker.selected {
        background-color: #10b981;
        width: 30px;
        height: 30px;
        line-height: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <div class="row">
        <div class="col-lg-12">
            <!-- Header -->
            <div class="card-glass p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-2">Find Hotels in {{ trip.destination.name }}</h2>
                        <p class="text-gray mb-0">
                            <i class="fas fa-calendar me-2"></i>{{ trip.start_date|date:"M d, Y" }} - {{ trip.end_date|date:"M d, Y" }}
                            <span class="mx-2">•</span>
                            <i class="fas fa-users me-2"></i>{{ trip.travelers }} traveler{% if trip.travelers > 1 %}s{% endif %}
                            <span class="mx-2">•</span>
                            <i class="fas fa-moon me-2"></i>{{ nights }} night{% if nights > 1 %}s{% endif %}
                        </p>
                    </div>
                    <a href="{% url 'planner:plan' %}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Planning
                    </a>
                </div>
                
                <!-- Map Container -->
                <div class="card-glass p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-map-marked-alt me-2"></i>Interactive Map
                        <small class="text-gray ms-2">Click on any hotel marker to book</small>
                    </h5>
                    
                    <div class="map-container">
                        <div id="hotelMap"></div>
                        <div class="map-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h6 class="mb-3">Map Controls</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showOurHotels" checked>
                                <label class="form-check-label" for="showOurHotels">
                                    <i class="fas fa-hotel text-primary me-1"></i>Our Hotels
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showRealHotels" checked>
                                <label class="form-check-label" for="showRealHotels">
                                    <i class="fas fa-map-marker-alt text-danger me-1"></i>Real Hotels
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Search and Filter Section -->
                <div class="card-glass p-4 mb-4">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label fw-bold">Search Hotels</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="hotelSearch" 
                                       placeholder="Search hotels by name, location, or amenities...">
                                <button class="btn btn-primary" type="button" id="searchRealHotelsBtn">
                                    <i class="fas fa-search me-2"></i>Find Real Hotels
                                </button>
                            </div>
                            <div id="realHotelsResults" class="mt-3">
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Real hotels available!</strong> You can book any of these hotels.
                                </div>
                                <div id="realHotelsList" class="row mt-3">
                                    <!-- Real hotels will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Sort By</label>
                            <select class="form-select" id="sortBy">
                                <option value="price_asc">Price: Low to High</option>
                                <option value="price_desc">Price: High to Low</option>
                                <option value="rating_desc">Rating: High to Low</option>
                                <option value="name_asc">Name: A to Z</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Price Range (MMK)</label>
                            <div class="input-group">
                                <span class="input-group-text">MMK</span>
                                <input type="number" class="form-control" placeholder="Min" id="minPrice" 
                                       min="0" max="1000000" step="1000" value="0">
                                <span class="input-group-text">to</span>
                                <input type="number" class="form-control" placeholder="Max" id="maxPrice" 
                                       min="0" max="1000000" step="1000" value="1000000">
                                <button class="btn btn-outline-primary" type="button" id="applyPriceFilter">
                                    Apply
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Categories</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-primary filter-category active" data-category="all">
                                    All Hotels
                                </button>
                                <button class="btn btn-sm btn-outline-primary filter-category" data-category="budget">
                                    <i class="fas fa-coins me-1"></i>Budget
                                </button>
                                <button class="btn btn-sm btn-outline-primary filter-category" data-category="medium">
                                    <i class="fas fa-home me-1"></i>Medium
                                </button>
                                <button class="btn btn-sm btn-outline-primary filter-category" data-category="luxury">
                                    <i class="fas fa-crown me-1"></i>Luxury
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hotels List -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card-glass p-4">
                            <h5 class="mb-4">
                                <i class="fas fa-list me-2"></i>Available Hotels
                                <span class="badge bg-primary ms-2" id="hotelCount">{{ hotels|length }}</span>
                            </h5>
                            
                            <div class="hotel-list-container" id="hotelsList">
                                {% for hotel in hotels %}
                                <div class="hotel-item card p-3 mb-3" 
                                     data-hotel-id="{{ hotel.id }}"
                                     data-name="{{ hotel.name|lower }}"
                                     data-category="{{ hotel.category }}"
                                     data-price="{{ hotel.price_per_night }}"
                                     data-rating="{{ hotel.rating }}"
                                     data-lat="{{ hotel.latitude|default:'' }}"
                                     data-lng="{{ hotel.longitude|default:'' }}"
                                     data-amenities="{{ hotel.amenities|join:','|lower }}"
                                     data-is-real="false">
                                    <div class="row">
                                        <div class="col-md-3">
                                            {% if hotel.image %}
                                            <img src="{{ hotel.image.url }}" alt="{{ hotel.name }}" 
                                                 class="img-fluid rounded" style="height: 120px; width: 100%; object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                                 style="height: 120px;">
                                                <i class="fas fa-hotel fa-2x text-gray"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="fw-bold mb-1">{{ hotel.name }}</h6>
                                            <p class="text-gray small mb-2">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ hotel.address|truncatechars:60 }}
                                            </p>
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="me-3">
                                                    <i class="fas fa-star text-warning me-1"></i>
                                                    <strong>{{ hotel.rating }}</strong>
                                                    <small class="text-gray">({{ hotel.review_count }})</small>
                                                </span>
                                                <span class="badge 
                                                    {% if hotel.category == 'budget' %}bg-success
                                                    {% elif hotel.category == 'medium' %}bg-warning
                                                    {% else %}bg-danger{% endif %}">
                                                    {{ hotel.get_category_display }}
                                                </span>
                                            </div>
                                            <div class="small">
                                                {% for amenity in hotel.amenities|slice:":4" %}
                                                <span class="badge bg-light text-dark me-1 mb-1">
                                                    <i class="fas fa-check me-1"></i>{{ amenity|title }}
                                                </span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <div class="mb-2">
                                                <div class="price-badge">
                                                    MMK {{ hotel.price_in_mmk }}
                                                </div>
                                                <small class="text-gray">per night</small>
                                            </div>
                                            {% with total=hotel.price_per_night|multiply:nights %}
                                            <p class="fw-bold mb-3">
                                                Total: <span class="text-teal">MMK {{ total|floatformat:0 }}</span>
                                            </p>
                                            {% endwith %}
                                            <button class="btn btn-sm btn-primary select-hotel-btn" 
                                                    data-hotel-id="{{ hotel.id }}">
                                                <i class="fas fa-check me-1"></i>Select
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center py-5">
                                    <div class="feature-icon gradient-bg mx-auto mb-4">
                                        <i class="fas fa-hotel fa-2x text-white"></i>
                                    </div>
                                    <h5 class="mb-3">No hotels available</h5>
                                    <p class="text-gray mb-4">
                                        No hotels found in {{ trip.destination.name }}.
                                        Try searching for real hotels.
                                    </p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selected Hotel Summary -->
                    <div class="col-lg-4">
                        <div class="card-glass p-4 sticky-top" style="top: 100px;">
                            <h5 class="mb-4">
                                <i class="fas fa-shopping-cart me-2"></i>Selected Hotel
                            </h5>
                            <div id="selectedHotelSummary" class="text-center py-4">
                                <div class="text-gray mb-3">
                                    <i class="fas fa-hotel fa-3x"></i>
                                </div>
                                <p class="text-gray">No hotel selected yet</p>
                                <p class="small text-gray">Click on any hotel from the list or map to select</p>
                            </div>
                            
                            <!-- Booking Forms -->
                            <form method="post" action="{% url 'planner:save_hotel' trip.id %}" id="ourHotelBookingForm" style="display: none;">
                                {% csrf_token %}
                                <input type="hidden" name="hotel_id" id="selectedHotelId">
                                
                                <div id="bookingDetails">
                                    <div class="border-top pt-3 mt-3">
                                        <h6 class="fw-bold">Booking Summary</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <td>Hotel:</td>
                                                <td class="text-end" id="bookingHotelName"></td>
                                            </tr>
                                            <tr>
                                                <td>Nights:</td>
                                                <td class="text-end">{{ nights }}</td>
                                            </tr>
                                            <tr>
                                                <td>Price per night:</td>
                                                <td class="text-end" id="bookingPricePerNight"></td>
                                            </tr>
                                            <tr class="fw-bold">
                                                <td>Total:</td>
                                                <td class="text-end" id="bookingTotalPrice"></td>
                                            </tr>
                                        </table>
                                        
                                        <button type="submit" class="btn btn-primary w-100 mt-3">
                                            <i class="fas fa-check-circle me-2"></i>Book This Hotel
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- Success Notice -->
                            <div class="alert alert-success mt-4">
                                <h6 class="fw-bold">
                                    <i class="fas fa-check-circle me-2"></i>Booking Available
                                </h6>
                                <p class="small mb-0">
                                    You can book both our hotels and real hotels!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
    let map;
    let markers = [];
    let realHotelsMarkers = [];
    let selectedHotelId = null;
    let selectedRealHotel = null;
    const centerLat = {{ center_lat|default:"16.8409" }};
    const centerLng = {{ center_lng|default:"96.1735" }};
    const nights = {{ nights }};
    
    // Simulated real hotels data for Myanmar
    const simulatedRealHotels = [
        {
            id: 'real-1',
            name: 'Sule Shangri-La Yangon',
            address: 'Sule Pagoda Road, Yangon, Myanmar',
            latitude: 16.7756,
            longitude: 96.1587,
            rating: 4.5,
            price: 250000,
            category: 'luxury',
            amenities: ['wifi', 'pool', 'spa', 'restaurant'],
            source: 'simulated'
        },
        {
            id: 'real-2', 
            name: 'Melia Yangon',
            address: '33, Alan Pya Phaya Road, Yangon, Myanmar',
            latitude: 16.7824,
            longitude: 96.1612,
            rating: 4.3,
            price: 180000,
            category: 'luxury',
            amenities: ['wifi', 'gym', 'restaurant', 'bar'],
            source: 'simulated'
        },
        {
            id: 'real-3',
            name: 'Hotel Grand United - 21st Downtown',
            address: '21st Street, Latha Township, Yangon, Myanmar',
            latitude: 16.7811,
            longitude: 96.1548,
            rating: 3.8,
            price: 60000,
            category: 'budget',
            amenities: ['wifi', 'breakfast', 'ac'],
            source: 'simulated'
        },
        {
            id: 'real-4',
            name: 'Bagan Thande Hotel',
            address: 'Bagan, Mandalay Region, Myanmar',
            latitude: 21.1722,
            longitude: 94.8603,
            rating: 4.2,
            price: 80000,
            category: 'medium',
            amenities: ['wifi', 'garden', 'restaurant'],
            source: 'simulated'
        },
        {
            id: 'real-5',
            name: 'Mandalay Hill Resort',
            address: 'Mandalay, Myanmar',
            latitude: 21.9594,
            longitude: 96.0936,
            rating: 4.1,
            price: 120000,
            category: 'medium',
            amenities: ['wifi', 'pool', 'spa', 'restaurant'],
            source: 'simulated'
        }
    ];
    
    // Custom icon for our hotels
    const ourHotelIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background-color: #3b82f6; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
        iconSize: [25, 25],
        iconAnchor: [12, 12]
    });
    
    // Custom icon for real hotels
    const realHotelIcon = L.divIcon({
        className: 'custom-marker real',
        html: '<div style="background-color: #ef4444; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
        iconSize: [25, 25],
        iconAnchor: [12, 12]
    });
    
    // Custom icon for selected hotels
    const selectedIcon = L.divIcon({
        className: 'custom-marker selected',
        html: '<div style="background-color: #10b981; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });
    
    function initMap() {
        // Initialize Leaflet map
        map = L.map('hotelMap').setView([centerLat, centerLng], 13);
        
        // Add OpenStreetMap tiles (FREE)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add markers for database hotels
        {% for hotel in hotels %}
        {% if hotel.latitude and hotel.longitude %}
        try {
            const lat = parseFloat('{{ hotel.latitude }}');
            const lng = parseFloat('{{ hotel.longitude }}');
            
            const marker = L.marker([lat, lng], {
                icon: ourHotelIcon
            }).addTo(map)
            .bindPopup(`
                <div style="min-width: 250px; padding: 10px;">
                    <h5 style="margin: 0 0 10px 0;">{{ hotel.name }}</h5>
                    <p style="color: #666; margin-bottom: 10px;">{{ hotel.address|truncatechars:50 }}</p>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span><i class="fas fa-star" style="color: #fbbf24;"></i> {{ hotel.rating }}</span>
                        <span style="font-weight: bold; color: #10b981;">MMK {{ hotel.price_in_mmk }}</span>
                    </div>
                    <button onclick="selectOurHotelOnMap({{ hotel.id }})" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 5px; width: 100%; cursor: pointer;">
                        <i class="fas fa-check me-2"></i>Select Hotel
                    </button>
                </div>
            `);
            
            markers.push({
                marker: marker,
                hotelId: {{ hotel.id }},
                isReal: false
            });
        } catch (e) {
            console.error('Error adding marker for hotel {{ hotel.id }}:', e);
        }
        {% endif %}
        {% endfor %}
        
        // AUTO-LOAD SIMULATED REAL HOTELS
        addSimulatedRealHotels();
        
        // Show real hotels in the list
        showRealHotels();
    }
    
    function addSimulatedRealHotels() {
        simulatedRealHotels.forEach(hotel => {
            const marker = L.marker([hotel.latitude, hotel.longitude], {
                icon: realHotelIcon
            }).addTo(map)
            .bindPopup(`
                <div style="min-width: 250px; padding: 10px;">
                    <h5 style="margin: 0 0 10px 0;">${hotel.name}</h5>
                    <p style="color: #666; margin-bottom: 10px;">${hotel.address}</p>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span><i class="fas fa-star" style="color: #fbbf24;"></i> ${hotel.rating}</span>
                        <span style="font-weight: bold; color: #10b981;">MMK ${hotel.price.toLocaleString()}</span>
                    </div>
                    <button onclick="selectRealHotelOnMap('${hotel.id}')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; width: 100%; cursor: pointer;">
                        <i class="fas fa-check me-2"></i>Book Real Hotel
                    </button>
                </div>
            `);
            
            realHotelsMarkers.push({
                marker: marker,
                hotel: hotel,
                isReal: true
            });
        });
    }
    
    function showRealHotels() {
        const container = document.getElementById('realHotelsList');
        
        let html = '';
        simulatedRealHotels.forEach(hotel => {
            const totalPrice = hotel.price * nights;
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card p-3 hotel-item real-hotel-item" 
                         data-hotel-id="${hotel.id}"
                         data-is-real="true"
                         onclick="selectRealHotelOnMap('${hotel.id}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="fw-bold mb-1">${hotel.name}</h6>
                            <span class="real-hotel-badge">Real Hotel</span>
                        </div>
                        <p class="small text-gray mb-2">
                            <i class="fas fa-map-marker-alt"></i> ${hotel.address}
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span><i class="fas fa-star text-warning"></i> ${hotel.rating}</span>
                            <span class="badge ${hotel.category === 'budget' ? 'bg-success' : hotel.category === 'medium' ? 'bg-warning' : 'bg-danger'}">
                                ${hotel.category}
                            </span>
                        </div>
                        <div class="mt-3">
                            <div class="price-badge">MMK ${hotel.price.toLocaleString()}</div>
                            <small class="text-gray">per night × ${nights} nights</small>
                            <p class="fw-bold mt-2">
                                Total: <span class="text-teal">MMK ${totalPrice.toLocaleString()}</span>
                            </p>
                            <button class="btn btn-sm btn-success w-100 mt-2"
                                    onclick="selectRealHotelOnMap('${hotel.id}')">
                                <i class="fas fa-check me-1"></i>Book This Hotel
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    function selectOurHotelOnMap(hotelId) {
        // Remove selection from all markers
        markers.forEach(item => {
            item.marker.setIcon(item.hotelId === hotelId ? selectedIcon : ourHotelIcon);
        });
        
        // Remove selection from real hotels
        realHotelsMarkers.forEach(item => {
            item.marker.setIcon(realHotelIcon);
        });
        
        // Update hotel item selection
        document.querySelectorAll('.hotel-item[data-is-real="false"]').forEach(item => {
            item.classList.toggle('selected', parseInt(item.dataset.hotelId) === hotelId);
        });
        
        // Clear real hotel selection
        document.querySelectorAll('.hotel-item[data-is-real="true"]').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Update booking form
        const hotelItem = document.querySelector(`[data-hotel-id="${hotelId}"][data-is-real="false"]`);
        if (hotelItem) {
            selectedHotelId = hotelId;
            selectedRealHotel = null;
            updateOurHotelBookingSummary(hotelItem);
        }
    }
    
    function selectRealHotelOnMap(hotelId) {
        const hotel = simulatedRealHotels.find(h => h.id === hotelId);
        if (!hotel) return;
        
        // Remove selection from our hotels
        markers.forEach(item => {
            item.marker.setIcon(ourHotelIcon);
        });
        
        // Update selection for real hotels
        realHotelsMarkers.forEach(item => {
            item.marker.setIcon(item.hotel.id === hotelId ? selectedIcon : realHotelIcon);
        });
        
        // Clear our hotel selection
        document.querySelectorAll('.hotel-item[data-is-real="false"]').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Update real hotel in list
        document.querySelectorAll('.real-hotel-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.hotelId === hotelId);
        });
        
        // Update booking form
        selectedHotelId = null;
        selectedRealHotel = hotel;
        updateRealHotelBookingSummary(hotel);
    }
    
    function updateOurHotelBookingSummary(hotelElement) {
        const hotelName = hotelElement.querySelector('h6').textContent;
        const price = parseFloat(hotelElement.dataset.price);
        const totalPrice = price * nights;
        
        // Update summary display
        document.getElementById('selectedHotelSummary').innerHTML = `
            <div class="text-center">
                <h6 class="fw-bold">${hotelName}</h6>
                <div class="price-badge mt-2">MMK ${price.toLocaleString()}</div>
                <p class="small text-gray mt-2">per night × ${nights} nights</p>
                <h5 class="mt-3 text-teal">MMK ${totalPrice.toLocaleString()}</h5>
                <p class="small text-success mt-2">
                    <i class="fas fa-check-circle me-1"></i>Available on our platform
                </p>
            </div>
        `;
        
        // Update booking form
        document.getElementById('selectedHotelId').value = selectedHotelId;
        document.getElementById('bookingHotelName').textContent = hotelName;
        document.getElementById('bookingPricePerNight').textContent = `MMK ${price.toLocaleString()}`;
        document.getElementById('bookingTotalPrice').textContent = `MMK ${totalPrice.toLocaleString()}`;
        
        // Show booking form
        document.getElementById('ourHotelBookingForm').style.display = 'block';
    }
    
    function updateRealHotelBookingSummary(hotel) {
        const price = hotel.price || 50000;
        const totalPrice = price * nights;
        
        // Update summary display
        document.getElementById('selectedHotelSummary').innerHTML = `
            <div class="text-center">
                <h6 class="fw-bold">${hotel.name}</h6>
                <span class="real-hotel-badge">Real Hotel</span>
                <div class="price-badge mt-2">MMK ${price.toLocaleString()}</div>
                <p class="small text-gray mt-2">per night × ${nights} nights</p>
                <h5 class="mt-3 text-teal">MMK ${totalPrice.toLocaleString()}</h5>
                <p class="small text-danger mt-2">
                    <i class="fas fa-external-link-alt me-1"></i>Simulated Booking
                </p>
            </div>
        `;
        
        // For real hotels, show alert for simulated booking
        document.getElementById('ourHotelBookingForm').style.display = 'none';
        
        // You can implement actual booking form here
        const bookBtn = document.createElement('button');
        bookBtn.className = 'btn btn-success w-100 mt-3';
        bookBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Simulate Booking';
        bookBtn.onclick = function() {
            if (confirm(`Simulate booking for: ${hotel.name}\nPrice: MMK ${price.toLocaleString()} × ${nights} nights = MMK ${totalPrice.toLocaleString()}\n\nThis is a simulated booking.`)) {
                alert('Booking simulated successfully!');
            }
        };
        
        // Remove previous custom button if exists
        const oldBtn = document.querySelector('#customBookingBtn');
        if (oldBtn) oldBtn.remove();
        
        bookBtn.id = 'customBookingBtn';
        document.getElementById('selectedHotelSummary').appendChild(bookBtn);
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        
        // Hotel item click (our hotels)
        document.querySelectorAll('.hotel-item[data-is-real="false"]').forEach(item => {
            item.addEventListener('click', function() {
                const hotelId = parseInt(this.dataset.hotelId);
                selectOurHotelOnMap(hotelId);
            });
        });
        
        // Select hotel button
        document.querySelectorAll('.select-hotel-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const hotelId = parseInt(this.dataset.hotelId);
                selectOurHotelOnMap(hotelId);
            });
        });
        
        // Map controls
        document.getElementById('showOurHotels').addEventListener('change', function() {
            markers.forEach(item => {
                item.marker.setOpacity(this.checked ? 1 : 0);
            });
        });
        
        document.getElementById('showRealHotels').addEventListener('change', function() {
            realHotelsMarkers.forEach(item => {
                item.marker.setOpacity(this.checked ? 1 : 0);
            });
        });
        
        // Search real hotels button
        document.getElementById('searchRealHotelsBtn').addEventListener('click', function() {
            document.getElementById('realHotelsResults').style.display = 'block';
            document.getElementById('realHotelsResults').scrollIntoView({ behavior: 'smooth' });
        });
    });
    // In the JavaScript section, add:
const hotelMarkers = {{ hotel_markers|safe }};

// Then use these markers to add to the map
hotelMarkers.forEach(hotel => {
    if (hotel.lat && hotel.lng) {
        const marker = L.marker([hotel.lat, hotel.lng], {
            icon: ourHotelIcon
        }).addTo(map)
        .bindPopup(`
            <div style="min-width: 250px;">
                <h5>${hotel.name}</h5>
                <p>${hotel.address}</p>
                <p>Price: MMK ${hotel.price_in_mmk}</p>
                <button onclick="selectHotel(${hotel.id})" class="btn btn-sm btn-primary w-100">
                    Select Hotel
                </button>
            </div>
        `);
        
        markers.push({
            marker: marker,
            hotelId: hotel.id,
            isReal: false
        });
    }
});
</script>
{% endblock %}