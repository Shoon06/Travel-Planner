{% extends 'base.html' %}
{% block title %}Select Seats - GoMyanmar{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card-glass p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-2">Select Your Seats</h2>
                        <p class="text-gray mb-0">
                            {% if transport_type == 'flight' %}
                                <i class="fas fa-plane me-2"></i>{{ transport.airline.name }} - Flight {{ transport.flight_number }}
                                <br>
                                <small class="text-gray">{{ transport.departure.name }} → {{ transport.arrival.name }} | {{ transport.get_duration_display }}</small>
                            {% elif transport_type == 'bus' %}
                                <i class="fas fa-bus me-2"></i>{{ transport.company }} - {{ transport.get_bus_type_display }}
                                <br>
                                <small class="text-gray">{{ transport.departure.name }} → {{ transport.arrival.name }} | {{ transport.get_duration_display }}</small>
                            {% endif %}
                        </p>
                    </div>
                    <a href="{% url 'planner:select_transport' trip.id %}?type={{ transport_type }}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Options
                    </a>
                </div>
                
                {% if transport_type == 'car' %}
                <!-- Car Rental - No seat selection needed -->
                <div class="card-glass p-5 text-center">
                    <div class="feature-icon gradient-teal mx-auto mb-4">
                        <i class="fas fa-car fa-2x text-white"></i>
                    </div>
                    <h4 class="mb-3">Car Selected!</h4>
                    <p class="text-gray mb-4">No seat selection needed for car rental.</p>
                    <form method="post" action="{% url 'planner:select_seats' trip.id transport.id %}?type=car">
                        {% csrf_token %}
                        <input type="hidden" name="transport_type" value="car">
                        <input type="hidden" name="selected_seats" value='[]'>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-check me-2"></i>Confirm Car Selection
                        </button>
                    </form>
                </div>
                
                {% else %}
                <!-- Booking Summary -->
                <div class="card-glass p-4 mb-4">
                    <div class="row">
                        <div class="col-md-8">
                            <h4 class="mb-2">
                                {% if transport_type == 'flight' %}
                                    {{ transport.departure.name }} → {{ transport.arrival.name }}
                                {% else %}
                                    {{ transport.departure.name }} → {{ transport.arrival.name }}
                                {% endif %}
                            </h4>
                            <p class="text-gray mb-0">
                                <i class="fas fa-users me-1"></i> Travelers: {{ trip.travelers }}
                                <span class="mx-2">|</span>
                                <i class="fas fa-calendar me-1"></i> Date: {{ travel_date|date:"M d, Y" }}
                                <span class="mx-2">|</span>
                                <i class="fas fa-chair me-1"></i> Available: {{ available_seats }} seats
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="price-display">
                                <h4 class="price-tag mb-2">
                                    {% if transport_type == 'flight' %}
                                        {{ transport.price_in_mmk|floatformat:0 }} MMK
                                    {% elif transport_type == 'bus' %}
                                        {{ transport.price_in_mmk|floatformat:0 }} MMK
                                    {% endif %}
                                </h4>
                                <p class="text-gray small mb-0">per seat</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seat Legend -->
                <div class="card-glass p-4 mb-4">
                    <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Seat Legend</h5>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <div class="seat seat-available me-2">1A</div>
                            <span class="text-gray">Available</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat seat-selected me-2">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                    <div style="font-size: 0.7rem; font-weight: 600;">1A</div>
                                    <i class="fas fa-check-circle" style="font-size: 0.7rem;"></i>
                                </div>
                            </div>
                            <span class="text-gray">Selected</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat seat-occupied me-2">
                                <i class="fas fa-lock fa-xs"></i>
                            </div>
                            <span class="text-gray">Occupied (Booked)</span>
                        </div>
                        {% if transport_type == 'flight' %}
                        <div class="d-flex align-items-center">
                            <div class="seat seat-premium me-2">1A</div>
                            <span class="text-gray">Premium/Extra Legroom</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat seat-first-class me-2">1A</div>
                            <span class="text-gray">First Class</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Seat Map -->
                <div class="card-glass p-4 mb-4">
                    <h5 class="mb-4"><i class="fas fa-chair me-2"></i>Select Your Seats</h5>
                    
                    {% if transport_type == 'bus' %}
                    <!-- Bus Seat Layout -->
                    <div class="seat-map-bus">
                        <!-- Driver Area -->
                        <div class="driver-area text-center mb-4">
                            <div class="driver-icon mx-auto mb-2">
                                <i class="fas fa-steering-wheel fa-2x text-gray"></i>
                            </div>
                            <p class="text-gray small mb-0">Driver</p>
                            <div class="bus-front mt-3 mb-4"></div>
                        </div>
                        
                        <!-- Bus Seats -->
                        <div class="bus-seats-container">
                            {% for row_data in seat_layout %}
                            <div class="bus-row mb-3">
                                <div class="row-number me-3">{{ row_data.row_number }}</div>
                                <div class="bus-seats d-flex gap-2">
                                    {% for seat in row_data.seats %}
                                    <div class="seat 
                                        {% if seat.occupied %}seat-occupied{% else %}seat-available{% endif %}
                                        {% if seat.is_window %}window-seat{% endif %}"
                                        data-seat="{{ seat.number }}"
                                        data-type="{{ seat.type }}"
                                        data-price-multiplier="{{ seat.price_multiplier }}"
                                        {% if seat.occupied %}data-occupied="true"{% endif %}>
                                        {% if seat.occupied %}
                                            <i class="fas fa-lock fa-xs"></i>
                                        {% else %}
                                            {{ seat.number }}
                                        {% endif %}
                                    </div>
                                    {% if forloop.counter == 2 %}
                                    <div class="aisle mx-2"></div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    {% elif transport_type == 'flight' %}
                    <!-- Flight Seat Layout -->
                    <div class="seat-map-flight">
                        <!-- Aircraft Layout -->
                        <div class="aircraft-nose text-center mb-4">
                            <i class="fas fa-plane fa-2x text-gray"></i>
                            <p class="text-gray small mb-0 mt-2">Front of Aircraft</p>
                        </div>
                        
                        <!-- First Class Section -->
                        {% for row_data in seat_layout %}
                            {% if row_data.is_first_class %}
                            <div class="first-class-section mb-4 p-3 rounded" style="background: rgba(139, 92, 246, 0.05);">
                                <h6 class="text-center mb-3 text-first-class">
                                    <i class="fas fa-crown me-2"></i>First Class
                                </h6>
                                <div class="row justify-content-center">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-center gap-2">
                                            {% for seat in row_data.seats %}
                                            <div class="seat 
                                                {% if seat.occupied %}seat-occupied{% elif seat.type == 'first' %}seat-first-class{% else %}seat-available{% endif %}"
                                                data-seat="{{ seat.number }}"
                                                data-type="{{ seat.type }}"
                                                data-price-multiplier="{{ seat.price_multiplier }}"
                                                {% if seat.occupied %}data-occupied="true"{% endif %}>
                                                {% if seat.occupied %}
                                                    <i class="fas fa-lock fa-xs"></i>
                                                {% else %}
                                                    {{ seat.number }}
                                                {% endif %}
                                            </div>
                                            {% if forloop.counter == 3 %}
                                            <div class="aisle mx-3"></div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Economy Class -->
                        <div class="economy-section">
                            <h6 class="text-center mb-3">
                                <i class="fas fa-users me-2"></i>Economy Class
                            </h6>
                            <div class="economy-seats">
                                {% for row_data in seat_layout %}
                                    {% if not row_data.is_first_class and not row_data.is_business_class %}
                                    <div class="row mb-2">
                                        <div class="col-1 text-end pe-0">
                                            <span class="row-label">{{ row_data.row_number }}</span>
                                        </div>
                                        <div class="col-10">
                                            <div class="d-flex justify-content-center gap-1">
                                                {% for seat in row_data.seats %}
                                                <div class="seat 
                                                    {% if seat.occupied %}seat-occupied
                                                    {% elif seat.type == 'premium' %}seat-premium
                                                    {% else %}seat-available{% endif %}"
                                                    data-seat="{{ seat.number }}"
                                                    data-type="{{ seat.type }}"
                                                    data-price-multiplier="{{ seat.price_multiplier }}"
                                                    {% if seat.occupied %}data-occupied="true"{% endif %}>
                                                    {% if seat.occupied %}
                                                        <i class="fas fa-lock fa-xs"></i>
                                                    {% else %}
                                                        {{ seat.number|slice:"-1:" }}
                                                    {% endif %}
                                                </div>
                                                {% if forloop.counter == 3 %}
                                                <div class="aisle mx-2"></div>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Aircraft Tail -->
                        <div class="aircraft-tail text-center mt-4">
                            <i class="fas fa-plane fa-rotate-180 fa-2x text-gray"></i>
                            <p class="text-gray small mb-0 mt-2">Rear of Aircraft</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Selected Seats Summary -->
                    <div class="selected-seats-summary mt-4 p-3 rounded" style="background: rgba(139, 92, 246, 0.05);">
                        <h6 class="mb-3"><i class="fas fa-check-circle me-2"></i>Selected Seats:</h6>
                        <div id="selectedSeatsList" class="d-flex flex-wrap gap-2 mb-3">
                            <div class="text-gray">No seats selected yet</div>
                        </div>
                        <div id="priceSummary" class="d-none">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>Total Price:</strong>
                                </div>
                                <div>
                                    <h5 class="price-tag mb-0" id="totalPrice">0 MMK</h5>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray small mb-0 mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Click on available seats to select them. You can select up to {{ trip.travelers }} seat(s).
                        </p>
                    </div>
                </div>
                
                <!-- Important Notice -->
                <div class="alert alert-warning mb-4">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="alert-heading">Important Notice</h6>
                            <p class="mb-1">Your seat selection is <strong>temporary</strong> until you confirm your entire trip.</p>
                            <p class="mb-0"><strong>Seats will only be permanently booked when you click "Confirm & Book Entire Trip" on the next page.</strong></p>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="card-glass p-4">
                    <form method="post" action="{% url 'planner:select_seats' trip.id transport.id %}" id="seatForm">
                        {% csrf_token %}
                        <input type="hidden" name="transport_type" value="{{ transport_type }}">
                        <input type="hidden" name="selected_seats" id="selectedSeatsInput" value='[]'>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{% url 'planner:select_transport' trip.id %}?type={{ transport_type }}" class="btn btn-outline-light">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Options
                                </a>
                            </div>
                            <div class="d-flex gap-3">
                                <button type="button" class="btn btn-outline-primary" onclick="clearSelections()">
                                    <i class="fas fa-times me-2"></i>Clear All
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg" id="confirmButton" disabled>
                                    <i class="fas fa-ticket-alt me-2"></i>Temporarily Reserve Seats
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Seat Styling */
    .seat {
        width: 45px;
        height: 45px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75rem;
        transition: all 0.2s ease;
        margin: 2px;
        position: relative;
        overflow: hidden;
    }
    
    .seat-available {
        background: white;
        border: 2px solid rgba(139, 92, 246, 0.3);
        color: var(--text-dark);
    }
    
    .seat-available:hover {
        background: rgba(139, 92, 246, 0.1);
        border-color: var(--primary-purple);
        transform: scale(1.05);
    }
    
    .seat-selected {
        background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
        border: 2px solid var(--primary-purple);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 5px rgba(139, 92, 246, 0.3);
        }
        50% {
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.6);
        }
        100% {
            box-shadow: 0 0 5px rgba(139, 92, 246, 0.3);
        }
    }
    
    .seat-occupied {
        background: rgba(107, 114, 128, 0.2);
        border: 2px solid rgba(107, 114, 128, 0.3);
        color: var(--text-gray);
        cursor: not-allowed;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .seat-occupied i {
        font-size: 0.8rem;
        color: rgba(107, 114, 128, 0.8);
    }
    
    .seat-premium {
        background: linear-gradient(135deg, #06B6D4, #0891B2);
        border: 2px solid #06B6D4;
        color: white;
    }
    
    .seat-first-class {
        background: linear-gradient(135deg, #F59E0B, #D97706);
        border: 2px solid #F59E0B;
        color: white;
    }
    
    /* Aisle Styling */
    .aisle {
        width: 30px;
        height: 45px;
        background: rgba(139, 92, 246, 0.05);
        border-radius: 5px;
    }
    
    /* Bus Layout */
    .bus-row {
        display: flex;
        align-items: center;
        padding: 5px 0;
    }
    
    .row-number {
        font-weight: 600;
        color: var(--text-gray);
        min-width: 30px;
        text-align: center;
    }
    
    .bus-seats-container {
        max-width: 400px;
        margin: 0 auto;
    }
    
    .driver-area {
        padding: 15px;
        background: rgba(139, 92, 246, 0.05);
        border-radius: 10px;
        max-width: 300px;
        margin: 0 auto 20px;
    }
    
    .bus-front {
        height: 10px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 5px;
    }
    
    .driver-icon {
        width: 50px;
        height: 50px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(139, 92, 246, 0.2);
    }
    
    /* Flight Layout */
    .aircraft-nose, .aircraft-tail {
        padding: 10px;
        background: rgba(139, 92, 246, 0.05);
        border-radius: 10px;
        max-width: 200px;
        margin: 0 auto;
    }
    
    .first-class-section {
        border: 2px solid rgba(245, 158, 11, 0.2);
    }
    
    .text-first-class {
        color: #F59E0B;
    }
    
    .economy-seats {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
    }
    
    .row-label {
        font-weight: 600;
        color: var(--text-gray);
        font-size: 0.9rem;
    }
    
    /* Selected Seat Badge */
    .selected-seat-badge {
        background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 5px rgba(139, 92, 246, 0.2);
    }
    
    .selected-seat-badge .remove-seat {
        cursor: pointer;
        padding: 2px;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        transition: background 0.2s;
    }
    
    .selected-seat-badge .remove-seat:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* Price Display */
    .price-display {
        background: rgba(139, 92, 246, 0.1);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .price-tag {
        color: var(--primary-purple);
        font-weight: 700;
    }
    
    .window-seat {
        position: relative;
    }
    
    .window-seat::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: 8px;
        border: 2px dashed rgba(139, 92, 246, 0.5);
        pointer-events: none;
    }
</style>

<script>
// Store Django template variables in JavaScript
const transportType = "{{ transport_type }}";
const travelersCount = {{ trip.travelers }};
const basePrice = {% if transport_type == 'flight' %}{{ transport.price }}{% elif transport_type == 'bus' %}{{ transport.price }}{% else %}0{% endif %};

document.addEventListener('DOMContentLoaded', function() {
    const selectedSeats = new Set();
    const selectedSeatsInput = document.getElementById('selectedSeatsInput');
    const selectedSeatsList = document.getElementById('selectedSeatsList');
    const confirmButton = document.getElementById('confirmButton');
    const priceSummary = document.getElementById('priceSummary');
    const totalPriceElement = document.getElementById('totalPrice');
    
    // Function to update selected seats display
    function updateSelectedSeats() {
        // Update the hidden input
        selectedSeatsInput.value = JSON.stringify(Array.from(selectedSeats));
        
        // Update the displayed list
        selectedSeatsList.innerHTML = '';
        
        if (selectedSeats.size === 0) {
            selectedSeatsList.innerHTML = '<div class="text-gray">No seats selected yet</div>';
            confirmButton.disabled = true;
            priceSummary.classList.add('d-none');
        } else {
            let totalPrice = 0;
            
            selectedSeats.forEach(seatNumber => {
                // Calculate seat price (premium seats cost more)
                let seatPrice = basePrice;
                const seatElement = document.querySelector('.seat[data-seat="' + seatNumber + '"]');
                if (seatElement) {
                    const priceMultiplier = parseFloat(seatElement.getAttribute('data-price-multiplier') || 1);
                    seatPrice = basePrice * priceMultiplier;
                }
                totalPrice += seatPrice;
                
                // Create badge
                const badge = document.createElement('div');
                badge.className = 'selected-seat-badge';
                badge.innerHTML = '<i class="fas fa-chair"></i>' +
                                 seatNumber +
                                 '<span class="remove-seat" data-seat="' + seatNumber + '" title="Remove seat">' +
                                 '<i class="fas fa-times"></i>' +
                                 '</span>';
                selectedSeatsList.appendChild(badge);
            });
            
            // Update price summary
            totalPriceElement.textContent = totalPrice.toLocaleString('en-US') + ' MMK';
            priceSummary.classList.remove('d-none');
            
            confirmButton.disabled = false;
        }
    }
    
    // Function to update seat visual
    function updateSeatVisual(seatElement, isSelected, seatType, seatNumber) {
        // Clear existing content
        seatElement.innerHTML = '';
        
        if (isSelected) {
            // For selected seats: show seat number with checkmark icon
            seatElement.classList.remove('seat-available', 'seat-premium', 'seat-first-class');
            seatElement.classList.add('seat-selected');
            
            // Create the selected seat content
            const contentDiv = document.createElement('div');
            contentDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; gap: 2px;';
            
            const seatNumberDiv = document.createElement('div');
            seatNumberDiv.style.cssText = 'font-size: 0.7rem; font-weight: 600;';
            seatNumberDiv.textContent = seatNumber;
            
            const checkIcon = document.createElement('i');
            checkIcon.className = 'fas fa-check-circle';
            checkIcon.style.cssText = 'font-size: 0.7rem;';
            
            contentDiv.appendChild(seatNumberDiv);
            contentDiv.appendChild(checkIcon);
            seatElement.appendChild(contentDiv);
        } else {
            // For available seats: show seat number with original styling
            seatElement.classList.remove('seat-selected');
            
            // Determine which class to add based on seat type
            if (seatType === 'premium' || seatElement.classList.contains('premium-seat')) {
                seatElement.classList.add('seat-premium');
                seatElement.textContent = seatNumber;
            } else if (seatType === 'first') {
                seatElement.classList.add('seat-first-class');
                seatElement.textContent = seatNumber;
            } else {
                seatElement.classList.add('seat-available');
                // For economy seats in flights, show just the letter
                if (transportType === 'flight' && !seatElement.classList.contains('seat-premium') && !seatElement.classList.contains('seat-first-class')) {
                    seatElement.textContent = seatNumber.slice(-1);
                } else {
                    seatElement.textContent = seatNumber;
                }
            }
        }
    }
    
    // Clear all selections
    window.clearSelections = function() {
        if (selectedSeats.size === 0) {
            alert('No seats selected to clear.');
            return;
        }
        
        if (confirm('Clear all selected seats?')) {
            selectedSeats.forEach(seatNumber => {
                const seatElement = document.querySelector('.seat[data-seat="' + seatNumber + '"]');
                if (seatElement && !seatElement.classList.contains('seat-occupied')) {
                    const seatType = seatElement.getAttribute('data-type');
                    updateSeatVisual(seatElement, false, seatType, seatNumber);
                }
            });
            selectedSeats.clear();
            updateSelectedSeats();
        }
    };
    
    // Seat click handler
    document.querySelectorAll('.seat:not(.seat-occupied)').forEach(seat => {
        seat.addEventListener('click', function() {
            if (this.classList.contains('seat-occupied')) {
                return;
            }
            
            const seatNumber = this.getAttribute('data-seat');
            const seatType = this.getAttribute('data-type');
            
            if (selectedSeats.has(seatNumber)) {
                // Deselect seat
                selectedSeats.delete(seatNumber);
                updateSeatVisual(this, false, seatType, seatNumber);
            } else {
                // Select seat (limit to trip travelers count)
                if (selectedSeats.size >= travelersCount) {
                    alert('You can only select up to ' + travelersCount + ' seat(s) for your trip.');
                    return;
                }
                
                selectedSeats.add(seatNumber);
                updateSeatVisual(this, true, seatType, seatNumber);
            }
            
            updateSelectedSeats();
        });
    });
    
    // Remove seat handler (from the summary list)
    selectedSeatsList.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-seat');
        if (removeBtn) {
            const seatNumber = removeBtn.getAttribute('data-seat');
            selectedSeats.delete(seatNumber);
            
            // Update the seat visual
            const seatElement = document.querySelector('.seat[data-seat="' + seatNumber + '"]');
            if (seatElement && !seatElement.classList.contains('seat-occupied')) {
                const seatType = seatElement.getAttribute('data-type');
                updateSeatVisual(seatElement, false, seatType, seatNumber);
            }
            
            updateSelectedSeats();
        }
    });
    
    // Form submission
    document.getElementById('seatForm').addEventListener('submit', function(e) {
        if (selectedSeats.size === 0) {
            e.preventDefault();
            alert('Please select at least one seat.');
            return false;
        }
        
        if (selectedSeats.size > travelersCount) {
            e.preventDefault();
            alert('You cannot select more than ' + travelersCount + ' seat(s).');
            return false;
        }
        
        // Show loading state
        confirmButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        confirmButton.disabled = true;
        
        // Show confirmation message
        const seatList = Array.from(selectedSeats).join(', ');
        const confirmMessage = 'Temporarily reserve these seats: ' + seatList + '\n\nIMPORTANT: These seats are NOT permanently booked yet. They will only be confirmed when you click "Confirm & Book Entire Trip" on the next page.\n\nDo you want to continue?';
        
        if (!confirm(confirmMessage)) {
            e.preventDefault();
            confirmButton.innerHTML = '<i class="fas fa-ticket-alt me-2"></i>Temporarily Reserve Seats';
            confirmButton.disabled = false;
            return false;
        }
    });
    
    // Initialize seats
    document.querySelectorAll('.seat').forEach(seat => {
        if (!seat.classList.contains('seat-occupied')) {
            const seatNumber = seat.getAttribute('data-seat');
            const seatType = seat.getAttribute('data-type');
            
            // Store the seat number in a data attribute for easy access
            seat.setAttribute('data-original-number', seatNumber);
            
            // Set initial visual
            if (seat.classList.contains('seat-premium')) {
                seat.textContent = seatNumber;
            } else if (seat.classList.contains('seat-first-class')) {
                seat.textContent = seatNumber;
            } else if (!seat.classList.contains('seat-available')) {
                seat.classList.add('seat-available');
                if (transportType === 'flight' && !seat.classList.contains('seat-premium') && !seat.classList.contains('seat-first-class')) {
                    seat.textContent = seatNumber.slice(-1);
                } else {
                    seat.textContent = seatNumber;
                }
            }
        }
    });
    
    updateSelectedSeats();
});
</script>
{% endblock %}