<!-- C:\Users\ASUS\MyanmarTravelPlanner\templates\users\admin_database_backup.html -->
{% extends 'base.html' %}
{% block title %}Database Backup - Admin - GoMyanmar{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <!-- Header -->
    <div class="card-glass p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2" style="color: #2c3e50;">Database Backup</h2>
                <p class="mb-0" style="color: #7f8c8d;">Manage database backups and restorations</p>
            </div>
            <button class="btn btn-primary" onclick="createBackup()">
                <i class="fas fa-plus me-2"></i>Create Backup
            </button>
        </div>
        
        <!-- Statistics -->
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="card-glass p-3 text-center">
                    <h4 class="mb-1" style="color: #2c3e50;">{{ backups|length }}</h4>
                    <p class="mb-0" style="color: #7f8c8d;">Total Backups</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-glass p-3 text-center">
                    <h4 class="mb-1" style="color: #2c3e50;">{% if backups %}{{ backups.0.date|date:"Y-m-d" }}{% else %}No backups{% endif %}</h4>
                    <p class="mb-0" style="color: #7f8c8d;">Latest Backup</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-glass p-3 text-center">
                    <h4 class="mb-1" style="color: #2c3e50;">30 days</h4>
                    <p class="mb-0" style="color: #7f8c8d;">Retention Period</p>
                </div>
            </div>
        </div>
        
        <!-- Backup Info -->
        <div class="alert alert-info" style="background: rgba(52, 152, 219, 0.1); border-color: #3498db;">
            <i class="fas fa-info-circle me-2"></i>
            Backups are stored in the <code>backups/</code> directory. Old backups (older than 30 days) are automatically deleted.
        </div>
    </div>
    
    <!-- Backup List -->
    <div class="card-glass p-4">
        <h4 style="color: #2c3e50;" class="mb-3">Available Backups</h4>
        
        {% if backups %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="color: #2c3e50;">Backup Name</th>
                        <th style="color: #2c3e50;">Date Created</th>
                        <th style="color: #2c3e50;">Size</th>
                        <th style="color: #2c3e50;">Age</th>
                        <th style="color: #2c3e50;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup in backups %}
                    <tr>
                        <td style="color: #34495e; font-weight: 500;">
                            <i class="fas fa-database me-2 text-primary"></i>
                            {{ backup.name }}
                        </td>
                        <td style="color: #7f8c8d;">{{ backup.date|date:"F d, Y H:i" }}</td>
                        <td style="color: #34495e;">{{ backup.size }}</td>
                        <td>
                            {% with age=backup.date|timesince %}
                            <span class="badge {% if 'day' in age or 'month' in age %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                {{ age }}
                            </span>
                            {% endwith %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary download-backup-btn" 
                                        data-backup-name="{{ backup.name }}">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success restore-backup-btn" 
                                        data-backup-name="{{ backup.name }}">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-backup-btn" 
                                        data-backup-name="{{ backup.name }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-database fa-4x text-gray mb-3"></i>
            <h5 style="color: #2c3e50;">No backups available</h5>
            <p style="color: #7f8c8d;">Create your first backup to secure your data</p>
            <button class="btn btn-primary" onclick="createBackup()">
                <i class="fas fa-plus me-2"></i>Create First Backup
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- Backup Instructions -->
    <div class="card-glass p-4 mt-4">
        <h4 style="color: #2c3e50;" class="mb-3">
            <i class="fas fa-question-circle me-2"></i>Backup Instructions
        </h4>
        <div class="row">
            <div class="col-md-6">
                <div class="card p-3 mb-3" style="background: rgba(255, 255, 255, 0.9);">
                    <h6 style="color: #2c3e50;">
                        <i class="fas fa-plus-circle text-success me-2"></i>Creating Backups
                    </h6>
                    <p class="mb-0 text-gray small">
                        Click "Create Backup" to create a new database backup. The backup will include all data including users, trips, destinations, and settings.
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 mb-3" style="background: rgba(255, 255, 255, 0.9);">
                    <h6 style="color: #2c3e50;">
                        <i class="fas fa-redo text-warning me-2"></i>Restoring Backups
                    </h6>
                    <p class="mb-0 text-gray small">
                        Click the restore button next to a backup to restore the database to that point. <strong>Warning:</strong> This will replace all current data.
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 mb-3" style="background: rgba(255, 255, 255, 0.9);">
                    <h6 style="color: #2c3e50;">
                        <i class="fas fa-download text-primary me-2"></i>Downloading Backups
                    </h6>
                    <p class="mb-0 text-gray small">
                        Download backups to your local computer for additional security. Keep backups in a safe location.
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 mb-3" style="background: rgba(255, 255, 255, 0.9);">
                    <h6 style="color: #2c3e50;">
                        <i class="fas fa-clock text-info me-2"></i>Automatic Backups
                    </h6>
                    <p class="mb-0 text-gray small">
                        Backups are automatically created daily at 2:00 AM. Old backups (30+ days) are automatically deleted to save space.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function createBackup() {
        if (confirm('Create a new database backup? This may take a few moments.')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = window.location.href;
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            form.appendChild(csrfInput);
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'create_backup';
            form.appendChild(actionInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Download backup
        document.querySelectorAll('.download-backup-btn').forEach(button => {
            button.addEventListener('click', function() {
                const backupName = this.getAttribute('data-backup-name');
                window.location.href = `/admin/download-backup/?file=${backupName}`;
            });
        });
        
        // Restore backup
        document.querySelectorAll('.restore-backup-btn').forEach(button => {
            button.addEventListener('click', function() {
                const backupName = this.getAttribute('data-backup-name');
                if (confirm(`WARNING: This will replace ALL current data with the backup "${backupName}". Are you sure?`)) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = window.location.href;
                    
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = '{{ csrf_token }}';
                    form.appendChild(csrfInput);
                    
                    const actionInput = document.createElement('input');
                    actionInput.type = 'hidden';
                    actionInput.name = 'action';
                    actionInput.value = 'restore_backup';
                    form.appendChild(actionInput);
                    
                    const backupInput = document.createElement('input');
                    backupInput.type = 'hidden';
                    backupInput.name = 'backup_name';
                    backupInput.value = backupName;
                    form.appendChild(backupInput);
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
        
        // Delete backup
        document.querySelectorAll('.delete-backup-btn').forEach(button => {
            button.addEventListener('click', function() {
                const backupName = this.getAttribute('data-backup-name');
                if (confirm(`Delete backup "${backupName}"? This cannot be undone.`)) {
                    fetch(`/admin/delete-backup/?file=${backupName}`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock %}