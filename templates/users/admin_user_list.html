{% extends 'base.html' %}
{% block title %}User Management - Admin - GoMyanmar{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <!-- Header -->
    <div class="card-glass p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2" style="color: #2c3e50;">User Management</h2>
                <p class="mb-0" style="color: #7f8c8d;">
                    Total: {{ total_users }} users ({{ admin_users }} admins, {{ regular_users }} regular users)
                </p>
            </div>
            <a href="{% url 'users:admin_add_user' %}" class="btn btn-primary">
                <i class="fas fa-user-plus me-2"></i>Add New User
            </a>
        </div>
        
        <!-- Search and Filters -->
        <div class="row">
            <div class="col-md-8">
                <form method="get" class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" placeholder="Search users by name, email..." 
                               value="{{ request.GET.q }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>
            <div class="col-md-4">
                <select class="form-select" id="userTypeFilter">
                    <option value="">All Users</option>
                    <option value="admin" {% if request.GET.type == 'admin' %}selected{% endif %}>Admins</option>
                    <option value="user" {% if request.GET.type == 'user' %}selected{% endif %}>Regular Users</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="card-glass p-4">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="color: #2c3e50;">User</th>
                        <th style="color: #2c3e50;">Email</th>
                        <th style="color: #2c3e50;">Type</th>
                        <th style="color: #2c3e50;">Joined</th>
                        <th style="color: #2c3e50;">Status</th>
                        <th style="color: #2c3e50;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if user.profile_picture %}
                                <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" 
                                     class="rounded-circle me-2" width="40" height="40">
                                {% else %}
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" 
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-user text-gray"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <strong style="color: #2c3e50;">{{ user.username }}</strong>
                                    {% if user.first_name or user.last_name %}
                                    <div class="text-gray small">{{ user.first_name }} {{ user.last_name }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td style="color: #34495e;">{{ user.email }}</td>
                        <td>
                            <span class="badge {% if user.user_type == 'admin' %}bg-danger{% else %}bg-primary{% endif %}">
                                {{ user.user_type|title }}
                            </span>
                        </td>
                        <td style="color: #7f8c8d;">{{ user.date_joined|date:"M d, Y" }}</td>
                        <td>
                            {% if user.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="/admin/users/customuser/{{ user.id }}/change/" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'users:admin_dashboard_user_roles' %}" 
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-user-tag"></i>
                                </a>
                                {% if user != request.user %}
                                <form method="post" action="{% url 'users:admin_dashboard_user_roles' %}" 
                                      class="d-inline" id="roleForm{{ user.id }}">
                                    {% csrf_token %}
                                    <input type="hidden" name="user_id" value="{{ user.id }}">
                                    <button type="button" class="btn btn-sm btn-outline-danger toggle-active" 
                                            data-user-id="{{ user.id }}">
                                        {% if user.is_active %}
                                        <i class="fas fa-user-slash"></i>
                                        {% else %}
                                        <i class="fas fa-user-check"></i>
                                        {% endif %}
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-users fa-3x text-gray mb-3"></i>
                            <h5 style="color: #2c3e50;">No users found</h5>
                            <p style="color: #7f8c8d;">Try adjusting your search criteria</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}">
                        Previous
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}">
                        {{ num }}
                    </a>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}">
                        Next
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // User type filter
        const userTypeFilter = document.getElementById('userTypeFilter');
        userTypeFilter.addEventListener('change', function() {
            const url = new URL(window.location);
            if (this.value) {
                url.searchParams.set('type', this.value);
            } else {
                url.searchParams.delete('type');
            }
            window.location.href = url.toString();
        });
        
        // Toggle user active status
        document.querySelectorAll('.toggle-active').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                if (confirm('Are you sure you want to change this user\'s active status?')) {
                    fetch(`/admin/user/${userId}/toggle-active/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock %}