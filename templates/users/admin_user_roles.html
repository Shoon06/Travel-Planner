<!-- C:\Users\ASUS\MyanmarTravelPlanner\templates\users\admin_user_roles.html -->
{% extends 'base.html' %}
{% block title %}User Role Management - Admin - GoMyanmar{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <!-- Header -->
    <div class="card-glass p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2" style="color: #2c3e50;">User Role Management</h2>
                <p class="mb-0" style="color: #7f8c8d;">Manage user roles and permissions</p>
            </div>
        </div>
    </div>
    
    <!-- Role Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card-glass p-3 text-center">
                <h3 class="mb-2" style="color: #2c3e50;">{{ users.count }}</h3>
                <p class="mb-0" style="color: #7f8c8d;">Total Users</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card-glass p-3 text-center">
                <h3 class="mb-2" style="color: #2c3e50;">{{ admin_count }}</h3>
                <p class="mb-0" style="color: #7f8c8d;">Admins</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card-glass p-3 text-center">
                <h3 class="mb-2" style="color: #2c3e50;">{{ user_count }}</h3>
                <p class="mb-0" style="color: #7f8c8d;">Regular Users</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card-glass p-3 text-center">
                <h3 class="mb-2" style="color: #2c3e50;">2</h3>
                <p class="mb-0" style="color: #7f8c8d;">Role Types</p>
            </div>
        </div>
    </div>
    
    <!-- Users Table with Role Management -->
    <div class="card-glass p-4">
        <form method="post" id="roleForm">
            {% csrf_token %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="color: #2c3e50;">User</th>
                            <th style="color: #2c3e50;">Current Role</th>
                            <th style="color: #2c3e50;">Change Role</th>
                            <th style="color: #2c3e50;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if user.profile_picture %}
                                    <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" 
                                         class="rounded-circle me-2" width="40" height="40">
                                    {% else %}
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" 
                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #6B47A4, #3498db);">
                                        <span class="text-white fw-bold">{{ user.username|first|upper }}</span>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <strong style="color: #2c3e50;">{{ user.username }}</strong>
                                        <div class="text-gray small">{{ user.email }}</div>
                                        {% if user == request.user %}
                                        <div class="text-warning small">(Your Account)</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if user.user_type == 'admin' %}
                                <span class="badge bg-danger px-3 py-2">
                                    <i class="fas fa-crown me-1"></i>Administrator
                                </span>
                                {% else %}
                                <span class="badge bg-primary px-3 py-2">
                                    <i class="fas fa-user me-1"></i>Regular User
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <select name="user_type" class="form-select role-select" 
                                        data-user-id="{{ user.id }}"
                                        {% if user == request.user %}disabled{% endif %}>
                                    {% for value, label in user_types %}
                                    <option value="{{ value }}" {% if user.user_type == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" name="user_id" class="user-id-input" value="{{ user.id }}">
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="submit" class="btn btn-sm btn-outline-primary save-role-btn" 
                                            name="action" value="update_role"
                                            data-user-id="{{ user.id }}"
                                            {% if user == request.user %}disabled{% endif %}>
                                        <i class="fas fa-save me-1"></i>Update
                                    </button>
                                    <a href="/admin/users/customuser/{{ user.id }}/change/" 
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <i class="fas fa-users fa-3x text-gray mb-3"></i>
                                <h5 style="color: #2c3e50;">No users found</h5>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const roleForm = document.getElementById('roleForm');
        
        // Handle form submission
        roleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = e.submitter || document.activeElement;
            if (submitButton && submitButton.name === 'action' && submitButton.value === 'update_role') {
                const userId = submitButton.getAttribute('data-user-id');
                const selectElement = this.querySelector(`.role-select[data-user-id="${userId}"]`);
                const newRole = selectElement.value;
                
                if (confirm('Are you sure you want to change this user\'s role?')) {
                    // Submit the form for this specific user
                    const userInput = this.querySelector(`.user-id-input[value="${userId}"]`);
                    const formData = new FormData(this);
                    
                    fetch('', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error updating role.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating role.');
                    });
                }
            }
        });
        
        // Update button state when role selection changes
        document.querySelectorAll('.role-select').forEach(select => {
            // Store original value
            const originalValue = select.value;
            const userId = select.getAttribute('data-user-id');
            const saveBtn = document.querySelector(`.save-role-btn[data-user-id="${userId}"]`);
            
            // Check if this is the current user's row
            const row = select.closest('tr');
            if (row.querySelector('.text-warning')) {
                // Disable for current user
                saveBtn.disabled = true;
                saveBtn.classList.remove('btn-outline-primary');
                saveBtn.classList.add('btn-outline-secondary');
                return;
            }
            
            select.addEventListener('change', function() {
                if (this.value !== originalValue) {
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('btn-outline-primary', 'btn-outline-secondary');
                    saveBtn.classList.add('btn-primary');
                } else {
                    saveBtn.disabled = true;
                    saveBtn.classList.remove('btn-primary');
                    saveBtn.classList.add('btn-outline-primary');
                }
            });
        });
    });
</script>
{% endblock %}